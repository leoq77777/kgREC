# 云训练迁移指南

## 📋 概述

由于本地训练效率低，本指南将帮助你将训练任务迁移到云计算平台，利用GPU资源加速训练。

## 🎯 推荐的云平台

### 1. GPU租赁平台（推荐新手）
- **Vast.ai** - 价格便宜，按小时计费（$0.1-2/小时）
- **RunPod** - 简单易用，预配置环境
- **Lambda Labs** - 专业GPU云服务
- **Paperspace** - 适合机器学习

### 2. 主流云平台
- **AWS EC2** - 功能全面，按需付费
- **Google Cloud Platform (GCP)** - 机器学习友好
- **Microsoft Azure** - 企业级服务
- **阿里云/腾讯云** - 国内访问快

## 📦 迁移前准备

### 1. 整理项目文件

需要上传的文件：

```
kgREC/
├── run_kgrec.py              # 主训练脚本
├── train_with_rocm.py        # 训练包装脚本
├── prepare_data_for_kgrec.py # 数据准备脚本
├── requirements.txt          # 依赖列表
├── setup_cloud_env.sh        # 环境设置脚本
├── train_cloud.sh            # 训练启动脚本
├── modules/                  # 模型代码
│   ├── KGRec.py
│   ├── AttnHGCN.py
│   └── contrast.py
├── utils/                    # 工具函数
│   ├── data_loader.py
│   ├── evaluate_kgsr.py
│   ├── parser.py
│   └── helper.py
└── ml-20m/                   # 数据集（可选，也可以重新生成）
    └── ml-20m/
        ├── train.txt
        ├── test.txt
        └── kg_final.txt
```

### 2. 创建部署脚本

我已经创建了以下脚本：
- `setup_cloud_env.sh` - 自动设置云环境
- `train_cloud.sh` - 启动训练
- `upload_to_cloud.sh` - 上传文件到云服务器
- `download_results.sh` - 下载训练结果

## 🚀 快速开始（以Vast.ai为例）

### 步骤1: 注册并创建实例

1. 访问 [vast.ai](https://vast.ai)
2. 注册账号并充值
3. 创建实例：
   - 选择GPU: RTX 3090/4090 或 A100（推荐）
   - 镜像: `pytorch/pytorch:latest` 或 `nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04`
   - 存储: 至少50GB
   - 网络: 启用SSH

### 步骤2: 上传代码

```bash
# 在本地执行
chmod +x upload_to_cloud.sh
./upload_to_cloud.sh root@<vast.ai提供的IP>:/root/kgREC
```

### 步骤3: 连接到服务器

```bash
ssh root@<vast.ai提供的IP>
```

### 步骤4: 设置环境

```bash
cd /root/kgREC
chmod +x setup_cloud_env.sh train_cloud.sh
bash setup_cloud_env.sh
```

### 步骤5: 准备数据

如果数据还没上传，需要准备数据：

```bash
# 方法1: 如果数据已上传
# 直接使用

# 方法2: 重新生成数据
python prepare_data_for_kgrec.py
```

### 步骤6: 开始训练

```bash
# 使用GPU训练（推荐）
bash train_cloud.sh

# 或者直接运行
python train_with_rocm.py \
    --dataset ml-20m \
    --data_path ml-20m/ml-20m/ \
    --epoch 50 \
    --batch_size 512 \
    --lr 1e-4 \
    --dim 64 \
    --save_interval 5
```

### 步骤7: 监控训练

```bash
# 查看实时输出
tail -f train_output.log

# 检查检查点
python check_checkpoints_now.py

# 查看GPU使用情况
watch -n 1 nvidia-smi
```

### 步骤8: 下载结果

训练完成后，在本地执行：

```bash
chmod +x download_results.sh
./download_results.sh root@<vast.ai提供的IP>:/root/kgREC
```

## 🔧 其他云平台配置

### AWS EC2

1. **创建实例**:
   - 选择: `Deep Learning AMI (Ubuntu)` 或 `p3.2xlarge` (V100 GPU)
   - 配置安全组，开放SSH端口

2. **连接**:
   ```bash
   ssh -i your-key.pem ubuntu@<ec2-ip>
   ```

3. **环境已预装CUDA和PyTorch**，直接安装依赖即可

### Google Cloud Platform

1. **创建实例**:
   - 选择: `n1-standard-4` + `NVIDIA T4` 或 `A100`
   - 镜像: `Deep Learning VM`

2. **连接**:
   ```bash
   gcloud compute ssh <instance-name> --zone=<zone>
   ```

### RunPod

1. **创建Pod**:
   - 选择GPU和预配置的PyTorch模板
   - 直接通过Web终端或SSH连接

2. **上传文件**:
   - 使用Web界面上传
   - 或使用SSH + rsync

## 📊 性能对比

| 平台 | GPU | 价格/小时 | 训练速度提升 |
|------|-----|----------|------------|
| 本地CPU | - | - | 1x (基准) |
| Vast.ai | RTX 3090 | $0.5-1 | 10-20x |
| Vast.ai | A100 | $1-2 | 20-40x |
| AWS EC2 | V100 | $3-5 | 15-25x |
| GCP | T4 | $0.35 | 8-15x |

## 💰 成本估算

假设训练50个epoch，每个epoch需要：
- **本地CPU**: 45分钟 → 总时间: 37.5小时
- **GPU (RTX 3090)**: 5分钟 → 总时间: 4小时

**成本对比**:
- **本地**: 电费约 $5-10
- **Vast.ai RTX 3090**: $0.5/小时 × 4小时 = **$2**
- **AWS EC2 V100**: $3/小时 × 4小时 = **$12**

## ⚙️ 优化建议

### 1. 使用GPU训练

修改 `train_cloud.sh`，移除 `--force_cpu`:

```bash
python train_with_rocm.py \
    --dataset ml-20m \
    --data_path ml-20m/ml-20m/ \
    --epoch 50 \
    --batch_size 512 \
    --lr 1e-4 \
    --dim 64 \
    --save_interval 5
    # 移除 --force_cpu，自动使用GPU
```

### 2. 调整批次大小

GPU内存更大，可以增加批次大小：

```bash
--batch_size 1024  # 或更大，根据GPU内存调整
```

### 3. 使用混合精度训练

可以修改代码添加混合精度训练（需要额外代码）

### 4. 数据预处理

- 如果数据很大，考虑在云上预处理
- 使用SSD存储加速数据加载

## 🔒 安全建议

1. **使用SSH密钥**，不要用密码
2. **定期备份检查点**到本地
3. **设置自动停止**，避免意外费用
4. **监控使用量**，及时停止不需要的实例

## 📝 检查清单

迁移前：
- [ ] 整理项目文件
- [ ] 测试本地代码可以运行
- [ ] 准备数据文件或数据生成脚本
- [ ] 创建云平台账号

迁移时：
- [ ] 上传代码文件
- [ ] 设置云环境
- [ ] 验证GPU可用
- [ ] 准备数据
- [ ] 启动训练

迁移后：
- [ ] 监控训练进度
- [ ] 定期检查检查点
- [ ] 下载训练结果
- [ ] 停止云实例（节省费用）

## 🆘 常见问题

### Q: 如何确保训练不会中断？

A: 
- 使用 `nohup` 或 `screen`/`tmux` 运行
- 定期保存检查点
- 设置自动重启脚本

### Q: 如何节省成本？

A:
- 使用按需实例，不用时停止
- 选择性价比高的GPU（RTX 3090通常比A100更划算）
- 优化训练时间（减少不必要的epoch）

### Q: 数据太大怎么办？

A:
- 使用云存储服务（S3, GCS等）
- 在云上直接下载/生成数据
- 使用数据压缩

### Q: 如何监控训练？

A:
- 使用 `tail -f train_output.log`
- 定期SSH连接检查
- 使用云平台的监控工具

## 🎯 下一步

1. **选择云平台**（推荐Vast.ai或RunPod开始）
2. **上传代码**（使用提供的脚本）
3. **设置环境**（运行setup脚本）
4. **开始训练**（享受GPU加速！）

## 📚 参考资源

- [Vast.ai 文档](https://vast.ai/docs/)
- [RunPod 文档](https://docs.runpod.io/)
- [AWS EC2 GPU实例](https://aws.amazon.com/ec2/instance-types/)
- [PyTorch GPU训练指南](https://pytorch.org/tutorials/beginner/blitz/cifar10_tutorial.html)

---

**祝训练顺利！** 🚀
